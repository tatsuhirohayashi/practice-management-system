FROM php:8.4-cli

RUN apt-get update && apt-get install -y \
    zip unzip git curl libpng-dev libonig-dev libxml2-dev \
    && docker-php-ext-install pdo_mysql mbstring exif pcntl bcmath gd

COPY --from=composer:2 /usr/bin/composer /usr/bin/composer

WORKDIR /var/www

# Laravel æœ¬ä½“
COPY backend/src/ /var/www/

# ä¾å­˜é–¢ä¿‚
RUN composer install \
    --no-dev \
    --no-scripts \
    --optimize-autoloader

# ğŸ”´ Laravel ãŒèµ·å‹•ã«å¿…è¦ãªãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å…¨ä½œæˆ
RUN mkdir -p \
    storage/logs \
    storage/framework/cache \
    storage/framework/sessions \
    storage/framework/views \
    bootstrap/cache \
 && chmod -R 777 storage bootstrap/cache

RUN php artisan config:clear || true \
 && php artisan cache:clear || true

EXPOSE 8080

# artisan ã‚’ä½¿ã‚ãš PHP æ¨™æº–ã‚µãƒ¼ãƒãƒ¼ï¼ˆå®‰å®šï¼‰
CMD ["sh", "-c", "php -S 0.0.0.0:${PORT} -t public"]
